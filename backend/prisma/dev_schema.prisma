generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ===================================================================
// ENUMS
// ===================================================================

enum UserRole {
  client
  designer
}

enum ClientType {
  doctor
  lab
}

enum DentalSpecialty {
  GENERAL_DENTISTRY
  ORTHODONTICS
  PERIODONTICS
  ENDODONTICS
  PROSTHODONTICS
  ORAL_SURGERY
  PEDIATRIC_DENTISTRY
  COSMETIC_DENTISTRY
  IMPLANTOLOGY
  ORAL_PATHOLOGY
  OTHER
}

enum OtpChannel {
  email
  whatsapp
}

enum OtpPurpose {
  login
  register
}

enum AccountStatus {
  active
  suspended
  deleted
  pending_approval
}

enum FailedLoginReason {
  wrong_otp
  account_locked
  account_suspended
}

enum ProcedureCategory {
  single_implant
  multiple_implant
  full_arch
  gbr
  other
}

enum GuideType {
  tooth_support
  tissue_support
  bone_support
  stackable
  hybrid
  other
}

enum RequiredService {
  study_only
  full_solution
}

enum ImplantSystem {
  nobel_biocare
  straumann
  zimmer_biomet
  osstem
  hiossen
  dentium
  megagen
  bicon
  neodent
  other
}

enum DeliveryMethod {
  pickup
  delivery
}

enum CaseStatus {
  // Initial states
  pending_study_payment_verification
  submitted

  // Study phase
  study_in_progress
  study_completed

  // Quote phase
  quote_pending
  quote_sent
  quote_accepted
  quote_rejected

  // Payment phase
  pending_production_payment_verification

  // Production phase
  in_production
  pending_response
  production_completed

  // Delivery phase
  ready_for_pickup
  out_for_delivery
  delivered

  // Final states
  completed
  cancelled
  refund_requested
  refunded
}

enum FileCategory {
  dicom
  stl
  ply
  zip
  clinical_photo
  prescription
  study_file
  design_file
  production_file
  other
}

enum PaymentStatus {
  pending
  verified
  failed
  refunded
}

enum PaymentMethod {
  bank_transfer
  cash
  hyperpay
}

enum PaymentType {
  study_fee
  production_fee
  delivery_fee
}

enum NotificationType {
  email
  whatsapp
  web
}

enum NotificationPurpose {
  otp
  welcome
  case_update
  case_submitted
  comment_added
  payment_reminder
  payment_verified
  payment_rejected
  quote_sent
  quote_accepted
  quote_rejected
  status_changed
  refund_requested
  refund_processed
  general_announcement
}

enum DiscountType {
  percentage
  fixed
}

enum Language {
  en
  ar
}

// ===================================================================
// CORE USER & PROFILE MODELS
// ===================================================================

model User {
  id Int @id @default(autoincrement())

  // Authentication
  email       String   @unique
  phoneNumber String?  @unique
  role        UserRole @default(client)

  // Verification
  emailVerified Boolean @default(false)
  phoneVerified Boolean @default(false)

  // Account status
  accountStatus AccountStatus @default(active)

  // Lockout fields
  failedLoginAttempts Int       @default(0)
  lastFailedLoginAt   DateTime?
  isLocked            Boolean   @default(false)
  lockedAt            DateTime?
  lockedUntil         DateTime?
  lockReason          String?
  UnlockedAt          DateTime?

  // User preferences
  preferredLanguage   Language  @default(en)
  timezone            String    @default("Asia/Riyadh")
  
  // Notification preferences
  notificationPreferences Json? // { email: true, whatsapp: false, web: true }

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  deletedAt     DateTime?
  approvedAt    DateTime?
  suspendedAt   DateTime?
  ReactivatedAt DateTime?

  // Relations
  otpCodes         OtpCode[]
  loginHistory     LoginHistory[]
  clientProfile    ClientProfile?
  designerProfile  DesignerProfile?
  notificationLogs NotificationLog[]

  @@index([email])
  @@index([phoneNumber])
  @@index([role])
  @@index([accountStatus])
  @@index([deletedAt])
}

model ClientProfile {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  clientType ClientType
  name       String

  profileImageUrl String?

  specialty      DentalSpecialty?
  specialtyOther String?

  clinicName String?
  labName    String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  caseStatusUpdates CaseStatusHistory[]
  addresses         Address[]
  cases             Case[]
  caseComments      CaseComment[]
  payments          Payment[]
  discountUsages DiscountUsage[]

  @@index([clientType])
  @@index([deletedAt])
}

model DesignerProfile {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String
  profileImageUrl String?

  // Designer info
  specialization  String?
  experienceYears Int?
  bio             String?

  // Admin & Permissions
  isAdmin Boolean @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  caseStatusUpdates CaseStatusHistory[]
  caseComments      CaseComment[]
  studiesCompleted  Case[]              @relation("StudyCompletedBy")
  quotesCreated     CaseQuote[]         @relation("QuoteCreatedBy")
  paymentsVerified  Payment[]           @relation("PaymentVerifiedBy")
  discountCodes DiscountCode[]
  
  @@index([isAdmin])
  @@index([deletedAt])
}

model Address {
  id              Int           @id @default(autoincrement())
  clientProfileId Int
  clientProfile   ClientProfile @relation(fields: [clientProfileId], references: [id], onDelete: Cascade)

  label String?

  country    String
  city       String
  district   String?
  street     String
  building   String?
  postalCode String?

  latitude  Float?
  longitude Float?
  placeId   String?

  isDefault Boolean @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  casesForDelivery Case[]

  @@index([clientProfileId, isDefault])
  @@index([deletedAt])
}

// ===================================================================
// AUTHENTICATION
// ===================================================================

model OtpCode {
  id Int @id @default(autoincrement())

  userId Int?
  user   User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  identifier String
  code       String
  channel    OtpChannel
  purpose    OtpPurpose

  expiresAt DateTime
  isUsed    Boolean   @default(false)
  usedAt    DateTime?
  attempts  Int       @default(0)

  createdAt DateTime @default(now())

  @@index([userId, isUsed, expiresAt])
  @@index([identifier, channel, purpose, isUsed, expiresAt])
  @@index([expiresAt])
}

model LoginHistory {
  id Int @id @default(autoincrement())

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  ipAddress  String?
  userAgent  String?
  location   String?
  deviceInfo String?

  success       Boolean
  failureReason FailedLoginReason?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([success, createdAt])
}

model TokenBlacklist {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token, expiresAt])
  @@index([userId])
}

// ===================================================================
// NOTIFICATION SYSTEM
// ===================================================================

model NotificationLog {
  id  Int   @id   @default(autoincrement())

  userId  Int?
  user    User?  @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification details
  type    NotificationType
  purpose NotificationPurpose
  
  recipient String // email, phone, or userId for web
  
  // Template and content
  templateUsed String?
  language     Language  @default(en)
  subject      String? 

  // Web notification specific
  title     String?
  body      String?
  actionUrl String?
  
  // Delivery status
  sent   Boolean   @default(false)
  sentAt DateTime?
  
  // Read status
  isRead Boolean   @default(false)
  readAt DateTime?
  
  // Error tracking
  error     String?
  errorCode String?
  
  // External service tracking
  messageId String?
  
  // Metadata
  metadata Json?
  
  createdAt DateTime @default(now())

  @@index([userId, type, createdAt])
  @@index([userId, purpose, createdAt])
  @@index([userId, isRead, createdAt]) // NEW - for unread queries
  @@index([sent, createdAt])
  @@index([createdAt])
}

// ===================================================================
// CASE MANAGEMENT
// ===================================================================

// FIXED: Changed onDelete to Cascade (clientProfileId stays non-null)
model Case {
  id         Int    @id @default(autoincrement())
  caseNumber String @unique

  // Client info - FIXED relation
  clientProfileId Int
  clientProfile   ClientProfile @relation(fields: [clientProfileId], references: [id], onDelete: Cascade)

  // Patient info
  patientRef String?

  // Procedure details
  procedureCategory ProcedureCategory
  guideType         GuideType
  requiredService   RequiredService

  // Clinical details
  implantSystem      ImplantSystem?
  implantSystemOther String?
  teethNumbers       String?

  // Case description
  clinicalNotes       String?
  specialInstructions String?

  // Status and workflow
  status      CaseStatus
  submittedAt DateTime?

  discountUsages DiscountUsage[]

  // Study tracking
  studyCompletedAt   DateTime?
  studyCompletedById Int?
  studyCompletedBy   DesignerProfile? @relation("StudyCompletedBy", fields: [studyCompletedById], references: [id])

  // Delivery info
  deliveryMethod     DeliveryMethod?
  deliveryAddressId  Int?
  deliveryAddress    Address?        @relation(fields: [deliveryAddressId], references: [id])
  pickupBranchId     Int?
  pickupBranch       Branch?         @relation(fields: [pickupBranchId], references: [id])
  actualDeliveryDate DateTime?

  // Timestamps
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  completedAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?
  deletedAt          DateTime?

  // Relations
  files         CaseFile[]
  comments      CaseComment[]
  statusHistory CaseStatusHistory[]
  quotes        CaseQuote[]
  payments      Payment[]

  @@index([clientProfileId, status])
  @@index([caseNumber])
  @@index([status, createdAt])
  @@index([deletedAt])
}

model CaseFile {
  id     Int  @id @default(autoincrement())
  caseId Int
  case   Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  fileName String
  fileUrl  String
  fileType String
  fileSize Int
  category FileCategory @default(other)

  description  String?
  uploadedBy   String
  uploadedById Int?

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([caseId, category])
  @@index([deletedAt])
}

model CaseComment {
  id     Int  @id @default(autoincrement())
  caseId Int
  case   Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  authorType        UserRole
  clientProfileId   Int?
  clientProfile     ClientProfile?   @relation(fields: [clientProfileId], references: [id])
  designerProfileId Int?
  designerProfile   DesignerProfile? @relation(fields: [designerProfileId], references: [id])

  comment String

  attachments String?

  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([caseId, createdAt])
  @@index([caseId, isRead])
  @@index([deletedAt])
}

model CaseStatusHistory {
  id     Int  @id @default(autoincrement())
  caseId Int
  case   Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  fromStatus CaseStatus?
  toStatus   CaseStatus

  changedByClientId   Int?
  changedByDesignerId Int?
  changedBy           UserRole

  client   ClientProfile?   @relation(fields: [changedByClientId], references: [id])
  designer DesignerProfile? @relation(fields: [changedByDesignerId], references: [id])

  notes String?

  createdAt DateTime @default(now())

  @@index([caseId, createdAt])
}

// ===================================================================
// QUOTES & PAYMENTS
// ===================================================================

model CaseQuote {
  id          Int    @id @default(autoincrement())
  quoteNumber String @unique

  caseId Int
  case   Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  studyFee      Float @default(100)
  designFee     Float @default(0)
  productionFee Float @default(0)
  deliveryFee   Float @default(0)

  subtotal       Float
  discountAmount Float   @default(0)
  discountReason String?

  discountCodeId    Int?
  discountCode      DiscountCode? @relation(fields: [discountCodeId], references: [id])
  discountUsages    DiscountUsage[]


  vatRate     Float @default(15)
  vatAmount   Float
  totalAmount Float

  isSent Boolean   @default(false)
  sentAt DateTime?

  isAccepted Boolean   @default(false)
  acceptedAt DateTime?

  isRejected      Boolean   @default(false)
  rejectedAt      DateTime?
  rejectionReason String?

  validUntil DateTime?

  internalNotes String?
  notes         String?

  createdById Int
  createdBy   DesignerProfile @relation("QuoteCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  payments Payment[]

  @@index([caseId])
  @@index([quoteNumber])
  @@index([createdById])
  @@index([deletedAt])
}

model Payment {
  id            Int    @id @default(autoincrement())
  paymentNumber String @unique

  caseId Int
  case   Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  quoteId Int?
  quote   CaseQuote? @relation(fields: [quoteId], references: [id])

  clientProfileId Int
  clientProfile   ClientProfile @relation(fields: [clientProfileId], references: [id])

  paymentType PaymentType
  amount      Float
  currency    String      @default("SAR")

  paymentMethod PaymentMethod
  status        PaymentStatus @default(pending)

  proofUrl        String?
  proofUploadedAt DateTime?

  hyperPayCheckoutId   String?
  hyperPayResourcePath String?

  cardLast4 String?
  cardBrand String?

  transactionId   String?
  transactionDate DateTime?

  isVerified      Boolean          @default(false)
  verifiedById    Int?
  verifiedBy      DesignerProfile? @relation("PaymentVerifiedBy", fields: [verifiedById], references: [id])
  verifiedAt      DateTime?
  rejectionReason String?

  isRefunded     Boolean   @default(false)
  refundedAmount Float?
  refundedAt     DateTime?
  refundReason   String?

  refundRequestedAt DateTime?
  refundNotes       String?

  notes     String?
  ipAddress String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([caseId, status])
  @@index([clientProfileId])
  @@index([paymentType, status])
  @@index([transactionId])
  @@index([verifiedById])
  @@index([deletedAt])
}

model DiscountCode {
  id                Int      @id @default(autoincrement())
  code              String   @unique
  
  // Discount configuration
  discountType      DiscountType
  discountValue     Float
  maxDiscountAmount Float?
  
  // Conditions
  minOrderAmount    Float    @default(0)
  maxUsesTotal      Int?
  maxUsesPerClient  Int?
  
  // Validity
  validFrom         DateTime
  validUntil        DateTime
  isActive          Boolean  @default(true)
  
  // Usage tracking
  timesUsed         Int      @default(0)
  
  // Metadata
  description       String?
  internalNotes     String?
  createdByAdminId  Int
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime?
  
  // Relations
  createdBy         DesignerProfile @relation(fields: [createdByAdminId], references: [id])
  quotes            CaseQuote[]
  usages            DiscountUsage[]
  
  @@index([code, isActive])
  @@index([validFrom, validUntil])
  @@index([deletedAt])
}

model DiscountUsage {
  id              Int      @id @default(autoincrement())
  
  discountCodeId  Int
  discountCode    DiscountCode @relation(fields: [discountCodeId], references: [id])
  
  clientProfileId Int
  clientProfile   ClientProfile @relation(fields: [clientProfileId], references: [id])
  
  caseId          Int
  case            Case @relation(fields: [caseId], references: [id])
  
  quoteId         Int
  quote           CaseQuote @relation(fields: [quoteId], references: [id])
  
  // Discount calculation
  originalAmount  Float
  discountAmount  Float
  finalAmount     Float
  
  appliedAt       DateTime @default(now())
  
  @@index([discountCodeId, clientProfileId])
  @@index([caseId])
  @@index([quoteId])
}

// ===================================================================
// SERVICE CATALOG & BRANCH
// ===================================================================

model ServiceCatalog {
  id   Int    @id @default(autoincrement())
  code String @unique

  procedureCategory ProcedureCategory
  guideType         GuideType
  requiredService   RequiredService

  name          String
  nameAr        String
  description   String?
  descriptionAr String?

  studyFee          Float  @default(100)
  baseDesignFee     Float  @default(0)
  baseProductionFee Float  @default(0)
  perToothFee       Float?

  isActive Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([procedureCategory, guideType, requiredService])
  @@index([isActive])
  @@index([deletedAt])
}

model Branch {
  id     Int     @id @default(autoincrement())
  name   String
  nameAr String?

  city     String
  district String?
  street   String
  phone    String?
  email    String?

  latitude  Float?
  longitude Float?

  workingHours String?

  isActive Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  casesForPickup Case[]

  @@index([isActive])
  @@index([deletedAt])
}
